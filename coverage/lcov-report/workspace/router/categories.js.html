<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for workspace/router/categories.js</title>
    <meta charset="utf-8">

    <link rel="stylesheet" href="../../prettify.css">

    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header low">
    <h1>Code coverage report for <span class="entity">workspace/router/categories.js</span></h1>
    <h2>
        
        Statements: <span class="metric">23.08% <small>(12 / 52)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 24)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">5.88% <small>(1 / 17)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">23.08% <small>(12 / 52)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">workspace/router/</a> &#187; categories.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">console.log("--loading categories routes");
var md = require('./middleware');
var async = require("async");
var validator = require("validator")
&nbsp;
var errorOut = <span class="fstat-no" title="function not covered" >function(res, msg){</span>
<span class="cstat-no" title="statement not covered" >    res.json({success: false, msg: msg});</span>
<span class="cstat-no" title="statement not covered" >    return null;</span>
};
&nbsp;
module.exports = function(app){
    
    
    app.get('/data/entries/view', md.checkuser, md.findcategoryObjects, md.findEntries, <span class="fstat-no" title="function not covered" >function(req, res){</span>
        //we need sequelize objects instead of a simple array
<span class="cstat-no" title="statement not covered" >       res.render('pages/user', {userid: req.user.id, style: 'dataitems', dataitems: req.items, categories: req.categories});</span>
    });
    
    app.get('/data/categories', md.checkuser, <span class="fstat-no" title="function not covered" >function(req, res){</span>
<span class="cstat-no" title="statement not covered" >        req.user.getCategories().then(<span class="fstat-no" title="function not covered" >function(d){</span></span>
<span class="cstat-no" title="statement not covered" >            res.render('pages/user', {userid: req.user.id, style: "categories", categories: d});</span>
        });        
    });
    
    app.get('/data/entries', md.checkuser, md.getCategories, <span class="fstat-no" title="function not covered" >function(req, res) {</span>
<span class="cstat-no" title="statement not covered" >        res.render('pages/user', {userid: req.user.id, style: "dataitems", categories: req.categories});    </span>
    });
    
    app.post('/data/entries', md.checkuser, <span class="fstat-no" title="function not covered" >function(req, res) {</span>
<span class="cstat-no" title="statement not covered" >        if((typeof req.body.category == 'undefined' || req.body.category === null)){</span>
<span class="cstat-no" title="statement not covered" >            return res.json({success: false, msg: "Sorry, please specify category "});</span>
        }
<span class="cstat-no" title="statement not covered" >        if (!validator.isInt(req.body.category)){</span>
<span class="cstat-no" title="statement not covered" >            return res.json({success: false, msg: "Invalid cateogry"});</span>
        }
<span class="cstat-no" title="statement not covered" >        req.user.getCategories({where: 'id = ' + req.body.category})</span>
        .then(<span class="fstat-no" title="function not covered" >function(cat){</span>
            
            // This was interesting.  Apparently, sequelize JS will 'find' a record in the database which does not 
            // exist, and return an empty array instad of follwoing 'function(err, record)' format.
            // The sure way to find an 'error' is to check that the first element of array does not exist
            
<span class="cstat-no" title="statement not covered" >            if(cat === [] || cat === null || typeof(cat[0]) === 'undefined'){</span>
<span class="cstat-no" title="statement not covered" >                return res.json({success: false, msg: "Unable to process request "});</span>
            }
<span class="cstat-no" title="statement not covered" >            console.log("Cateogries " + JSON.stringify(cat[0]));</span>
<span class="cstat-no" title="statement not covered" >            global.db.Dataitem.create({</span>
                lat: req.body.latitude, 
                lon: req.body.longitude, 
                temp: req.body.temp, 
                amount: req.body.amount, 
                description: req.body.description
                })
            .complete(<span class="fstat-no" title="function not covered" >function(err, d){</span>
<span class="cstat-no" title="statement not covered" >                if(err){</span>
<span class="cstat-no" title="statement not covered" >                    console.log(err);</span>
<span class="cstat-no" title="statement not covered" >                    return res.json({success: false, msg: "Unable to create the item - please make sure all field are filled in "});</span>
                }
                
<span class="cstat-no" title="statement not covered" >                d.setDaysSinceLast(cat[0].lastEntry);</span>
<span class="cstat-no" title="statement not covered" >                cat[0].updateCategory();</span>
<span class="cstat-no" title="statement not covered" >                cat[0].addDataitem(d)</span>
                .then(<span class="fstat-no" title="function not covered" >function(){</span>
<span class="cstat-no" title="statement not covered" >                    return res.json({success: true, msg: "Item added"});</span>
                })
                .catch(<span class="fstat-no" title="function not covered" >function(err){</span>
<span class="cstat-no" title="statement not covered" >                    console.log("Unable to add data item for some reason ");</span>
<span class="cstat-no" title="statement not covered" >                    return res.json({success: false, msg: "Error when adding the item "});</span>
                });
            });
        });
    });
    
    app.post('/data/categories', md.checkuser, <span class="fstat-no" title="function not covered" >function(req, res){</span>
<span class="cstat-no" title="statement not covered" >       var desc = req.body.description;</span>
<span class="cstat-no" title="statement not covered" >       global.db.Category.create({label: desc})</span>
       .complete(<span class="fstat-no" title="function not covered" >function(err, c){</span>
<span class="cstat-no" title="statement not covered" >          if(err){</span>
<span class="cstat-no" title="statement not covered" >              res.json({success: false, msg: "Sorry, category must be letter+number combination, and less than 140 characters"});</span>
          } else {
<span class="cstat-no" title="statement not covered" >              req.user.addCategory(c).complete(<span class="fstat-no" title="function not covered" >function(err, next){</span></span>
<span class="cstat-no" title="statement not covered" >              if (err){</span>
<span class="cstat-no" title="statement not covered" >                  res.json({success: false, msg: "Sorry, there has been a database error of some sort"});</span>
              } else {
<span class="cstat-no" title="statement not covered" >                  res.json({success: true, msg: "Category added", label: c.label});</span>
              }
          });}
    });
    });
    
    app.post('/data/categories/delete/:id', md.checkuser, <span class="fstat-no" title="function not covered" >function(req, res){</span>
<span class="cstat-no" title="statement not covered" >        var cat_id = req.params['id'];</span>
<span class="cstat-no" title="statement not covered" >        if(!validator.isInt(cat_id)){</span>
<span class="cstat-no" title="statement not covered" >            return res.json({success: false, msg: "Sorry, invalid category"});</span>
        }
<span class="cstat-no" title="statement not covered" >        req.user.getCategories({where: 'id = ' + cat_id}).success(<span class="fstat-no" title="function not covered" >function(c){</span></span>
<span class="cstat-no" title="statement not covered" >            if(c &amp;&amp; c != [] &amp;&amp; c[0]){</span>
<span class="cstat-no" title="statement not covered" >                c[0].destroy().success(<span class="fstat-no" title="function not covered" >function(){</span></span>
<span class="cstat-no" title="statement not covered" >                  res.json({success: true, msg: "Category " + c[0].label + " removed "});  </span>
                });
            } else {
<span class="cstat-no" title="statement not covered" >                res.json({success: false, msg: "Error occured when removing category"});</span>
            }
        });
        
    });
};
&nbsp;
&nbsp;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Mar 03 2015 07:36:42 GMT+0000 (UTC)</div>
</div>

<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>

<script src="../../sorter.js"></script>
</body>
</html>
